# Skew Protection Implementation

This document describes the skew protection implementation for the Logosophe Cloudflare Worker.

## What is Skew Protection?

Skew protection helps handle requests that might be routed to different versions of your worker during deployments. It ensures that users get a consistent experience even when deployments are in progress.

## Implementation Details

### Configuration Files Updated

1. **wrangler.jsonc**: Added `run_worker_first: true` to the assets configuration and configured routes for production domain
2. **next.config.mjs**: Added `deploymentId: getDeploymentId()` for unique deployment tracking
3. **.dev.vars**: Added required environment variables for local development
4. **.open-next/cloudflare/skew-protection.js**: Enabled skew protection logic

### Domain Configuration

The worker is configured to handle the production domain:
- **Production**: `www.logosophe.com` (managed by Cloudflare Workers)

**Note**: `local-dev.logosophe.com` is managed by Cloudflare Tunnel for local development and is not configured in the worker routes to avoid DNS conflicts.

### Required Environment Variables

For skew protection to work, you need to set these environment variables:

- `CF_WORKER_NAME`: The name of your worker (set to "logosophe")
- `CF_PREVIEW_DOMAIN`: The subdomain for preview deployments (set to "anchorwrite.workers.dev")
- `CF_WORKERS_SCRIPTS_API_TOKEN`: API token with "Workers Scripts:Read" permission
- `CF_ACCOUNT_ID`: Your Cloudflare account ID

### Deployment

Use the provided deployment script:

```bash
# Set your API token first
export CF_WORKERS_SCRIPTS_API_TOKEN=your_api_token_here

# Run the deployment script
./deploy-with-skew-protection.sh
```

### How It Works

1. Each deployment gets a unique `deploymentId` generated by `getDeploymentId()`
2. When a request comes in with a specific deployment ID (via `x-deployment-id` header or `dpl` query parameter)
3. The worker checks if this deployment ID exists in the deployment mapping
4. If it exists and is different from the current deployment, the request is forwarded to the older deployment
5. This ensures users get the version they expect, even during deployments

### Testing

To test skew protection:

1. Deploy your worker
2. Make a request with a specific deployment ID:
   ```bash
   # Test production domain
   curl -H "x-deployment-id: your-deployment-id" https://www.logosophe.com
   ```
   or
   ```bash
   # Test production domain
   curl "https://www.logosophe.com?dpl=your-deployment-id"
   ```

### Local Development

For local development with `local-dev.logosophe.com`:
- The domain is managed by Cloudflare Tunnel
- Skew protection is not needed for local development
- The tunnel routes traffic directly to your local development server

### Important Notes

- Skew protection only works for custom domains, not for `.workers.dev` domains
- Requests to older deployments will be slightly slower (few milliseconds)
- The system maintains up to 20 previous versions by default
- Versions older than 7 days are automatically cleaned up
- Only `www.logosophe.com` is managed by the worker for skew protection
- `local-dev.logosophe.com` is managed by Cloudflare Tunnel for local development

## Troubleshooting

If skew protection isn't working:

1. Check that all environment variables are set correctly
2. Verify your API token has the correct permissions
3. Ensure you're testing with the production domain (`www.logosophe.com`)
4. Check the worker logs for any error messages
5. Verify that the production domain is properly configured in your Cloudflare DNS

## References

- [OpenNext Skew Protection Documentation](https://opennext.js.org/cloudflare/howtos/skew)
- [Cloudflare Workers Documentation](https://developers.cloudflare.com/workers/) 