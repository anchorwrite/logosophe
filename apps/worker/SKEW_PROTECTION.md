# Skew Protection Implementation

This document describes the skew protection implementation for the Logosophe Cloudflare Worker.

## What is Skew Protection?

Skew protection helps handle requests that might be routed to different versions of your worker during deployments. It ensures that users get a consistent experience even when deployments are in progress.

## Implementation Details

### Configuration Files Updated

1. **wrangler.jsonc**: Added `run_worker_first: true` to the assets configuration
2. **next.config.mjs**: Added `deploymentId: getDeploymentId()` for unique deployment tracking
3. **.dev.vars**: Added required environment variables for local development
4. **.open-next/cloudflare/skew-protection.js**: Enabled skew protection logic

### Required Environment Variables

For skew protection to work, you need to set these environment variables:

- `CF_WORKER_NAME`: The name of your worker (set to "logosophe")
- `CF_PREVIEW_DOMAIN`: The subdomain for preview deployments (set to "anchorwrite.workers.dev")
- `CF_WORKERS_SCRIPTS_API_TOKEN`: API token with "Workers Scripts:Read" permission
- `CF_ACCOUNT_ID`: Your Cloudflare account ID

### Deployment

Use the provided deployment script:

```bash
# Set your API token first
export CF_WORKERS_SCRIPTS_API_TOKEN=your_api_token_here

# Run the deployment script
./deploy-with-skew-protection.sh
```

### How It Works

1. Each deployment gets a unique `deploymentId` generated by `getDeploymentId()`
2. When a request comes in with a specific deployment ID (via `x-deployment-id` header or `dpl` query parameter)
3. The worker checks if this deployment ID exists in the deployment mapping
4. If it exists and is different from the current deployment, the request is forwarded to the older deployment
5. This ensures users get the version they expect, even during deployments

### Testing

To test skew protection:

1. Deploy your worker
2. Make a request with a specific deployment ID:
   ```bash
   curl -H "x-deployment-id: your-deployment-id" https://logosophe.com
   ```
   or
   ```bash
   curl "https://logosophe.com?dpl=your-deployment-id"
   ```

### Important Notes

- Skew protection only works for custom domains, not for `.workers.dev` domains
- Requests to older deployments will be slightly slower (few milliseconds)
- The system maintains up to 20 previous versions by default
- Versions older than 7 days are automatically cleaned up

## Troubleshooting

If skew protection isn't working:

1. Check that all environment variables are set correctly
2. Verify your API token has the correct permissions
3. Ensure you're testing with a custom domain, not a `.workers.dev` domain
4. Check the worker logs for any error messages

## References

- [OpenNext Skew Protection Documentation](https://opennext.js.org/cloudflare/howtos/skew)
- [Cloudflare Workers Documentation](https://developers.cloudflare.com/workers/) 